# Jiminy Desktop App

Menu bar app shell for Jiminy (macOS only).

## Run

```bash
npm install
npm start
```

## Tests

```bash
npm test
npm run test:unit:timed
npm run test:modelProviderTests
```

-   `npm test` runs unit tests (excludes `test/modelProviderTests`).
-   `npm run test:unit:timed` runs unit tests and fails if they take longer than 2s (override with `JIMINY_UNIT_TEST_TIME_LIMIT_MS`).
-   `npm run test:modelProviderTests` runs live provider tests (requires `LLM_API_KEY`).

## E2E Tests (Playwright)

```bash
npm run test:e2e
```

E2E helpers:

-   `JIMINY_E2E=1` opens the Settings window on launch and bypasses native dialogs.
-   `JIMINY_E2E_CONTEXT_PATH` supplies the folder picker result.
-   `JIMINY_SETTINGS_DIR` overrides the settings storage directory.
-   `JIMINY_LLM_MOCK=1` replaces LLM calls with a mock summarizer/extractor.
-   `JIMINY_LLM_MOCK_TEXT` sets the mock summary text (default: `gibberish`).
-   On Linux CI/E2E runs (`JIMINY_E2E=1` or `CI=true`), the app disables GPU and sandbox flags to improve launch reliability.

## Run GitHub CI locally

Use `act` from the repo root to run the CI job:

```bash
act -W .github/workflows/ci.yml -s LLM_API_KEY=YOUR_KEY
```

## GitHub CI (exact run details)

CI runs on `ubuntu-latest` with Node.js 20 and uses the `code/desktopapp` working directory. Steps:

```bash
npm ci
npx playwright install --with-deps
npm test
npm run test:modelProviderTests
xvfb-run --auto-servernum -- npm run test:e2e
```

Environment:

-   `CI=true`
-   `LLM_API_KEY` from GitHub secrets (used by model provider tests)
-   E2E tests also launch Electron with `--no-sandbox --disable-gpu --disable-dev-shm-usage` on Linux/CI.
    -   `--no-sandbox`: required in many CI/container setups where the Chromium sandbox cannot initialize (no user namespaces).
    -   `--disable-gpu`: avoids GPU initialization failures under Xvfb/headless Linux.
    -   `--disable-dev-shm-usage`: avoids crashes when `/dev/shm` is tiny in containers (uses disk instead).

## Publish desktop release (manual)

The workflow `Publish Desktop Release` is a manual GitHub Actions job that builds the macOS artifacts and publishes them to `jiminy-releases`.

-   Workflow: `.github/workflows/release-desktopapp.yml`
-   Requires secret: `RELEASE_REPO_GITHUB_TOKEN`
-   Uses `CSC_IDENTITY_AUTO_DISCOVERY=false` until signing/notarization is configured.

## Notes

-   The app runs from the macOS menu bar with a Settings window that stores the Context Folder Path, LLM provider, and API key in `~/.jiminy/settings.json`.
-   The Settings wizard starts with Context Folder selection; the General tab lets you change it anytime.
-   Auto-launch on login is enabled via Electron login item settings.
-   The tray menu includes a **Capture Selection** overlay (drag to select, release to capture) that saves a PNG to `<contextFolderPath>/jiminy/jiminy-captures`. It requires macOS Screen Recording permission in **System Settings > Privacy & Security > Screen Recording**.
-   The Settings window includes a **Recording** tab with an opt-in **Record while active** toggle plus manual start/stop. When enabled (and permission granted), Jiminy records silent, downsampled `.mp4` segments (H.264, 2 fps, 0.5 scale) into `<contextFolderPath>/jiminy/recordings/session-<timestamp>/` with a `manifest.json` describing segments and stop reason.
-   A global hotkey triggers the same capture flow: `Command+Shift+J` on macOS (Electron accelerator `CommandOrControl+Shift+J`).
-   Captures enqueue a background extraction task (`sourceType: "image"`) which runs the selected provider's vision extractor and writes a Markdown file next to the PNG as `<capture>.png-extraction.md`. Extraction is skipped if no API key is configured and mocking is disabled.
-   Clipboard and screenshot analysis outputs are saved under `<contextFolderPath>/jiminy/analysis`.
-   The tray icon shows a pulsating ring while extraction or analysis queues are active. The animation listens to queue lifecycle events and keeps an in-memory active set so overlapping extraction + analysis keep the ring alive; it stops only when both queues report idle. The ring frames are generated by masking the base tray icon (no external assets). For persistent history (e.g. status across restarts), we would log queue events to SQLite in a later phase.

## License

[CC0 1.0 (Public Domain)](LICENSE.md)

## Architecture Overview

```
                           ┌─────────────────────────────┐
                           │         Menu Bar Tray        │
                           └──────────────┬──────────────┘
                                          │
                      ┌───────────────────┴───────────────────┐
                      │                                       │
                      ▼                                       ▼
           ┌─────────────────────┐                 ┌──────────────────────┐
           │    Settings Window  │                 │   Capture Selection  │
           └──────────┬──────────┘                 └──────────┬───────────┘
                      │                                       │
                      ▼                                       ▼
           ┌─────────────────────┐                 ┌──────────────────────┐
           │ ~/.jiminy/settings  │                 │   Capture Overlay     │
           └──────────┬──────────┘                 └──────────┬───────────┘
          ┌───────────┴───────────┐                            │
          │                       │                            ▼
          ▼                       ▼                 ┌──────────────────────┐
┌──────────────────┐   ┌──────────────────┐        │ PNG saved to           │
│ Context Folder   │   │ LLM Provider +   │        │ <context>/jiminy/      │
│                  │   │ API Key          │        │ jiminy-captures/*.png  │
└──────────┬───────┘   └──────────────────┘        │                        │
           │                                       └──────────┬───────────┘
           │                                                  │
           │                                                  ▼
           │                                       ┌──────────────────────┐
           │                                       │ extractionQueue       │
           │                                       │ enqueue:              │
           │                                       │ { sourceType: image,  │
           │                                       │   metadata: { path } }│
           │                                       └──────────┬───────────┘
           │                                                  │
           ▼                                                  ▼
┌──────────────────────┐                          ┌──────────────────────┐
│ Clipboard Capture    │                          │ Image Extraction      │
│ (Clipboard text)     │                          │ Handler               │
└──────────┬───────────┘                          └──────────┬───────────┘
           │                                                  │
           ▼                                                  ▼
┌──────────────────────┐                          ┌──────────────────────┐
│ clipboard-*.md saved │                          │ LLM Vision API       │
│ to <context>/jiminy/ │                          └──────────┬───────────┘
│ jiminy-captures      │                                     │
└──────────┬───────────┘                                     ▼
           │                                       ┌──────────────────────┐
           │                                       │ <capture>.png-        │
           │                                       │ extraction.md         │
           │                                       └──────────┬───────────┘
           │                                                  │
           │                                                  ▼
           │                                       ┌──────────────────────┐
           │                                       │ analysisQueue         │
           │                                       │ enqueue:              │
           │                                       │ { result_md_path }    │
           │                                       └──────────┬───────────┘
           │                                                  │
           ▼                                                  ▼
┌──────────────────────┐                          ┌──────────────────────┐
│ Analysis Handler     │                          │ <analysis>.md saved   │
└──────────────────────┘                          │ to <context>/jiminy/  │
                                                  │ analysis               │
                                                  └──────────────────────┘
```

tests:

-   if image is empty, show user that permissions are still an issue
